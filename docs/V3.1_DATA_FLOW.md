# Evidence Toolkit v3.1 - Enhanced Data Flow

**Visual guide to v3.1 Layer 1 AI enhancements**

---

## Overview

v3.1 adds AI-powered legal pattern detection and power dynamics analysis to the v3.0 foundation. This diagram shows how enhancements flow through the pipeline from ingestion to client package.

---

## Complete v3.1 Pipeline Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         EVIDENCE INGESTION                                │
│                       (unchanged from v3.0)                               │
└──────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
          ┌──────────────────────────────────────────────┐
          │  Content-Addressed Storage (SHA256 hashing)  │
          │  data/storage/raw/sha256=<hash>/            │
          │  data/storage/derived/sha256=<hash>/        │
          └──────────────────────────────────────────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                        AI ANALYSIS STAGE                                  │
│                     (v3.1 ENHANCEMENTS ADDED)                            │
└──────────────────────────────────────────────────────────────────────────┘
         │                         │                         │
         ▼                         ▼                         ▼
    ┌─────────┐             ┌─────────┐              ┌─────────┐
    │Document │             │  Email  │              │  Image  │
    │Analyzer │             │Analyzer │              │Analyzer │
    └─────────┘             └─────────┘              └─────────┘
         │                         │                         │
         │                         │                         │
         ▼                         ▼                         ▼
┌─────────────────┐    ┌──────────────────────┐    ┌─────────────┐
│DocumentAnalysis │    │EmailThreadAnalysis   │    │ImageAnalysis│
│                 │    │                      │    │Result       │
│v3.1 ENHANCED:   │    │v3.1 NEW FIELDS:      │    │             │
│• relationship   │    │• message_count       │    │(unchanged)  │
│• quoted_text    │    │• deference_score     │    │             │
│• associated_    │    │• dominant_topics     │    │             │
│  event          │    │                      │    │             │
└─────────────────┘    └──────────────────────┘    └─────────────┘
         │                         │                         │
         └─────────────────────────┼─────────────────────────┘
                                   ▼
                    ┌─────────────────────────┐
                    │  UnifiedAnalysis Model  │
                    │  (saved to storage)     │
                    └─────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                     CORRELATION ANALYSIS STAGE                            │
│                  (v3.1 AI PATTERN DETECTION ADDED)                       │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────┐
                    │  CorrelationAnalyzer     │
                    │  (with openai_client)    │
                    └──────────────────────────┘
                                   │
            ┌──────────────────────┼──────────────────────┐
            ▼                      ▼                      ▼
    ┌──────────────┐     ┌──────────────────┐   ┌──────────────┐
    │ Entity       │     │  Timeline        │   │  v3.1 NEW:   │
    │ Correlation  │     │  Reconstruction  │   │  AI Pattern  │
    │              │     │                  │   │  Detection   │
    │(using v3.1   │     │(using v3.1       │   │              │
    │ enhanced     │     │ enhanced         │   │              │
    │ entities)    │     │ classifications) │   │              │
    └──────────────┘     └──────────────────┘   └──────────────┘
            │                      │                      │
            │                      │                      │
            └──────────────────────┼──────────────────────┘
                                   ▼
                    ┌──────────────────────────────────┐
                    │  CorrelationAnalysis Model       │
                    │                                  │
                    │  v3.1 NEW FIELDS:                │
                    │  • legal_patterns                │
                    │    - contradictions              │
                    │    - corroboration               │
                    │    - evidence_gaps               │
                    │  • temporal_sequences            │
                    │  • timeline_gaps                 │
                    └──────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      SUMMARY GENERATION STAGE                             │
│              (v3.1 ENHANCEMENT DATA PRESERVED)                           │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────┐
                    │  SummaryGenerator        │
                    │  (extracts v3.1 data)    │
                    └──────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────────────┐
                    │  CaseSummary Model               │
                    │                                  │
                    │  Includes:                       │
                    │  • EvidenceSummary (v3.1 fields) │
                    │  • CorrelationAnalysis           │
                    │    (with legal_patterns)         │
                    │  • Executive Summary (AI)        │
                    └──────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      CLIENT PACKAGE GENERATION                            │
│                 (v3.1 DATA PRESERVED WITH model_dump())                  │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────┐
                    │  PackageGenerator        │
                    │  (uses model_dump())     │
                    └──────────────────────────┘
                                   │
                ┌───────────────────┼───────────────────┐
                ▼                   ▼                   ▼
        ┌─────────────┐    ┌───────────────┐  ┌────────────────┐
        │ Executive   │    │  Correlation  │  │ Evidence       │
        │ Summary     │    │  Report       │  │ Catalog        │
        │             │    │               │  │                │
        │ (includes   │    │ v3.1 FIELDS:  │  │ (includes v3.1 │
        │  AI legal   │    │ • legal_      │  │  participant   │
        │  assessment)│    │   patterns    │  │  counts)       │
        │             │    │ • temporal_   │  │                │
        │             │    │   sequences   │  │                │
        │             │    │ • timeline_   │  │                │
        │             │    │   gaps        │  │                │
        │             │    │               │  │                │
        │             │    │ (SHA256s      │  │                │
        │             │    │  truncated    │  │                │
        │             │    │  for          │  │                │
        │             │    │  readability) │  │                │
        └─────────────┘    └───────────────┘  └────────────────┘
                │                   │                   │
                └───────────────────┼───────────────────┘
                                    ▼
                    ┌────────────────────────────┐
                    │  Professional ZIP Package  │
                    │  (Forensic-Grade Output)   │
                    └────────────────────────────┘
```

---

## v3.1 Enhancement Details

### 1. Document Analysis Enhancements

**Before (v3.0):**
```json
{
  "entity": {
    "name": "Paul Boucherat",
    "type": "person",
    "confidence": 0.95,
    "context": "Email from Paul to HR"
  }
}
```

**After (v3.1):**
```json
{
  "entity": {
    "name": "Paul Boucherat",
    "type": "person",
    "confidence": 0.95,
    "context": "Email from Paul to HR",
    "relationship": "sent email to Rachel Hemmings",
    "quoted_text": "This behavior will not be tolerated",
    "associated_event": null
  }
}
```

**Impact**: Enables relationship graphs, verbatim evidence tracking, temporal event linking

---

### 2. Email Power Dynamics Analysis

**Before (v3.0):**
```json
{
  "participant": {
    "email_address": "manager@company.com",
    "role": "sender",
    "authority_level": "management",
    "confidence": 0.95
  }
}
```

**After (v3.1):**
```json
{
  "participant": {
    "email_address": "manager@company.com",
    "role": "sender",
    "authority_level": "management",
    "confidence": 0.95,
    "message_count": 5,
    "deference_score": 0.15,
    "dominant_topics": [
      "investigation process",
      "documentation requirements",
      "deadlines"
    ]
  }
}
```

**Interpretation**:
- `deference_score: 0.15` = **HIGHLY DOMINANT** (red flag for abuse of power)
- `message_count: 5` = Sent majority of messages
- `dominant_topics` = Controlled conversation direction

**Use Case**: Workplace investigations detecting power imbalances, intimidation, hostile environments

---

### 3. Legal Pattern Detection (Cross-Evidence AI)

**NEW in v3.1**: AI analyzes correlation data to detect legal patterns

```
CorrelationAnalyzer (with openai_client)
         ↓
   Context Building:
   • Top 20 entity correlations
   • 30 timeline events
   • 10 evidence summaries
         ↓
   OpenAI Responses API:
   • Model: gpt-4.1-mini
   • Prompt: CORRELATION_PATTERN_PROMPT
   • Output: LegalPatternAnalysis (Pydantic)
         ↓
   Pattern Detection:
   • Contradictions (factual, temporal, attribution)
   • Corroboration (weak, moderate, strong)
   • Evidence gaps (missing witnesses, docs, absences)
         ↓
   Saved in CorrelationAnalysis.legal_patterns
```

**Example Output:**
```json
{
  "legal_patterns": {
    "contradictions": [
      {
        "statement_1": "No prior performance issues documented",
        "statement_1_source": "2401112d",
        "statement_2": "Multiple warnings issued over 6 months",
        "statement_2_source": "7f3a8b9e",
        "contradiction_type": "factual",
        "severity": 0.88
      }
    ],
    "corroboration": [
      {
        "claim": "Manager exhibited hostile behavior toward employee",
        "supporting_evidence": ["2401112d", "7f3a8b9e", "9c4d3f1a"],
        "corroboration_strength": "strong",
        "explanation": "Three independent sources confirm pattern"
      }
    ],
    "evidence_gaps": [
      "Missing: HR complaint documentation",
      "Missing: Witness statements from team members",
      "Unexplained gap in email communication (14 days)"
    ]
  }
}
```

---

### 4. Temporal Pattern Analysis

**NEW in v3.1**: Timeline events include AI classification for pattern detection

**Timeline Event (v3.1):**
```json
{
  "timestamp": "2024-08-17T09:30:00",
  "evidence_sha256": "2401112d...",
  "event_type": "communication",
  "description": "Email: Complaint filed with HR",
  "confidence": 1.0,
  "ai_classification": {
    "legal_significance": "high",
    "communication_pattern": "escalating",
    "risk_flags": ["retaliation", "hostile_environment"]
  }
}
```

**Temporal Sequence Detection:**
- Finds events within 72-hour windows
- Filters by legal significance (high/critical)
- Identifies escalation clusters
- Aggregates risk flags

**Timeline Gap Detection:**
- Detects gaps > 7 days
- Assesses significance (low/medium/high)
- Flags potential evidence spoliation

**Example Sequence:**
```json
{
  "temporal_sequence": {
    "anchor_event": {
      "timestamp": "2024-08-17T09:30:00",
      "description": "Complaint filed with HR",
      "legal_significance": "high"
    },
    "related_events": [
      {
        "timestamp": "2024-08-18T14:00:00",
        "description": "Manager meeting with employee"
      },
      {
        "timestamp": "2024-08-19T10:00:00",
        "description": "Performance improvement plan issued"
      }
    ],
    "time_span_hours": 48.5,
    "legal_significance": "high",
    "risk_flags": ["retaliation"]
  }
}
```

---

## Data Flow Through Package Generation

### v3.1 Preservation Strategy

**Key Challenge**: Client packages must preserve all v3.1 enhancement data

**Solution**: Use Pydantic `model_dump(mode='json')` throughout

```python
# WRONG (v3.0 approach - loses v3.1 fields):
correlation_dict = {
    "entity_correlations": [corr.__dict__ for corr in correlations],
    "timeline_events": [event.__dict__ for event in events]
}

# CORRECT (v3.1 approach - preserves all fields):
correlation_dict = case_summary.correlation_result.model_dump(mode='json')
```

**Result**: All v3.1 fields preserved in client package:
- `EmailParticipant.deference_score`
- `DocumentEntity.relationship`
- `CorrelationAnalysis.legal_patterns`
- `TimelineEvent.ai_classification`

---

## SHA256 Truncation for Readability

**Why truncate?**
- Full SHA256: `2401112d2c3bcc883a713fc238830307c1d596f74b28110d3137675529191c8c`
- Truncated: `2401112d` (8 characters)

**Readability improvement**: Legal professionals can reference evidence without 64-character hashes

**Implementation**:
```python
# Truncate in correlation report
for corr in correlation_dict["entity_correlations"]:
    for occ in corr["evidence_occurrences"]:
        occ["evidence_sha256"] = occ["evidence_sha256"][:8]

# Truncate in legal_patterns
for contradiction in correlation_dict["legal_patterns"]["contradictions"]:
    contradiction["statement_1_source"] = contradiction["statement_1_source"][:8]
    contradiction["statement_2_source"] = contradiction["statement_2_source"][:8]
```

**Note**: Original full SHA256s preserved in raw analysis files for verification

---

## v3.1 Enhancement Impact Summary

| Component | v3.0 | v3.1 Enhancement | Benefit |
|-----------|------|------------------|---------|
| **DocumentEntity** | Name, type, confidence, context | + relationship, quoted_text, associated_event | Relationship graphs, verbatim evidence, temporal linking |
| **EmailParticipant** | Email, role, authority | + message_count, deference_score, dominant_topics | Power dynamics analysis, intimidation detection |
| **CorrelationAnalysis** | Entities, timeline | + legal_patterns, temporal_sequences, timeline_gaps | AI contradiction detection, corroboration analysis |
| **TimelineEvent** | Basic event data | + ai_classification | Pattern-aware temporal analysis |
| **Package Output** | Standard reports | + legal_patterns section, power dynamics data | Enhanced forensic insights for legal teams |

---

## Performance & Cost Impact

### Processing Time
- v3.0 baseline: 2-3 minutes for 5 evidence pieces
- v3.1 addition: +10-20 seconds (AI pattern detection)
- **Total**: ~3-4 minutes for 5 evidence pieces

### OpenAI API Costs
- Document analysis: $0.001-0.003 (unchanged)
- Email analysis: $0.002-0.005 (unchanged)
- **NEW** Legal pattern detection: $0.005-0.010 per case
- **Total increase**: ~$0.01-0.02 per case (marginal)

### Cost-Benefit
- Minimal cost increase (<10%)
- Major forensic value increase (contradiction detection, power dynamics)
- **ROI**: Exceptional for legal investigations

---

## Future v3.2+ Enhancements (Planned)

**Layer 2 - Advanced Pattern Detection:**
- Credibility scoring across sources
- Bias detection in witness accounts
- Emotional trajectory analysis

**Layer 3 - Predictive Analysis:**
- Litigation outcome prediction
- Settlement recommendation
- Risk scoring for legal exposure

---

*This document provides a comprehensive visual guide to v3.1 enhancements. For technical implementation details, see:*
- [CORRELATION_ANALYZER.md](module-docs/CORRELATION_ANALYZER.md) - Cross-evidence correlation
- [models.md](api/models.md) - Pydantic model definitions
- [pipeline/*.md](pipeline/) - Pipeline stage documentation
